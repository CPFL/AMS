<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>AMS-CLI</title>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script>
      let map=null;
      let viewData = {};
      let startWaypoint = null;
      let goalWaypoint = null;

      function setStartSpot(waypointID) {
        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            console.log(this.readyState, this.status);
        };
        xhttp.open("GET", "http://" + window.location.hostname + ":" + window.location.port + "/setStartSpot/" + waypointID, true);
        xhttp.send();
      }

      function setGoalSpot(waypointID) {
        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            console.log(this.readyState, this.status);
        };
        xhttp.open("GET", "http://" + window.location.hostname + ":" + window.location.port + "/setGoalSpot/" + waypointID, true);
        xhttp.send();
      }

      function sendRequest() {
        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            console.log(this.readyState, this.status);
        };
        xhttp.open("GET", "http://" + window.location.hostname + ":" + window.location.port + "/sendRequest", true);
        xhttp.send();
      }

      function drawStopSpots() {
        for(const waypointID in viewData["stopSpots"]) {
          const lat = viewData["stopSpots"][waypointID]["lat"];
          const lng = viewData["stopSpots"][waypointID]["lng"];

          let color = "#00a3e0";
          let radius = 0.2;
          let fillOpacity = 0.0;

          var stopSpot = new google.maps.Circle({
              label: waypointID,
              strokeColor: color,
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: color,
              fillOpacity: fillOpacity,
              map: map,
              center: {lat: lat, lng: lng},
              radius: radius
          });
          stopSpot.addListener("click", function() {
            console.log(this.label);
            if(startWaypoint === null) {
              setStartSpot(this.label);

              const color = "#00FF00";
              const radius = 0.5;
              const fillOpacity = 0.0;

              startWaypoint = new google.maps.Circle({
                  label: this.label,
                  strokeColor: color,
                  strokeOpacity: 0.8,
                  strokeWeight: 2,
                  fillColor: color,
                  fillOpacity: fillOpacity,
                  map: map,
                  center: {lat: lat, lng: lng},
                  radius: radius
              });
            }
            else if(goalWaypoint === null) {
              setGoalSpot(this.label);

              const color = "#FF0000";
              const radius = 0.5;
              const fillOpacity = 0.0;

              goalWaypoint = new google.maps.Circle({
                  label: this.label,
                  strokeColor: color,
                  strokeOpacity: 0.8,
                  strokeWeight: 2,
                  fillColor: color,
                  fillOpacity: fillOpacity,
                  map: map,
                  center: {lat: lat, lng: lng},
                  radius: radius
              });

              sendRequest();
            }
          });
        }
      }

      function initMap() {
        console.log("initMap", viewData);

        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 19,
          center: {lat: parseFloat(viewData["viewPoint"]["lat"]), lng: parseFloat(viewData["viewPoint"]["lng"])},
          mapTypeId: 'terrain'
        });

        drawStopSpots();
      };

      function onLoad() {
        const xhttpWaypoints = new XMLHttpRequest();
        xhttpWaypoints.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                viewData = JSON.parse(this.responseText);
                initMap();
            }
        };
        xhttpWaypoints.open("GET", "http://" + window.location.hostname + ":" + window.location.port + "/getViewData", true);
        xhttpWaypoints.send();
      };
    </script>
  </head>
  <body onLoad="onLoad()">
    <div id="map"></div>
  </body>
</html>
